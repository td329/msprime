.. _sec-file-format:

=========================
Tree Sequence File Format
=========================

The correlated trees output by a coalescent simulation are stored very
concisely in ``msprime`` as a sequence of coalescent records. To make this
information as efficient and easy as possible to use, we store the data in a
`HDF5 <https://www.hdfgroup.org/HDF5/>`_ based file format. This page fully
documents this format allowing efficient and convenient access to the
genealogical data generated by ``msprime`` outside of the native :ref:`Python
API <sec-api>`. Using the specification defined here, it should be
straightforward to access tree sequence information in any language with `HDF5
support <https://en.wikipedia.org/wiki/Hierarchical_Data_Format#Interfaces>`_.

*********
Structure
*********

The file format is broken into a number of groups. Each group contains
datasets to define the data along with attributes to provide necessary
contextual information.

The root group contains a number of attributes, describing the basic
properties of data set. The ``format_version`` attribute is a
pair ``(major, minor)`` describing the file format version. This is
document describes version 0.1.

================    ==============      ======      ===========
Path                Type                Dim         Description
================    ==============      ======      ===========
/format_version     H5T_STD_U32LE       2           The file format version (major, minor).
/sample_size        H5T_STD_U32LE       Scalar      The simulated sample size :math:`n`.
/sequence_length    H5T_STD_U32LE       Scalar      The simulated sequence length :math:`m`.
================    ==============      ======      ===========

+++++++++++
Trees group
+++++++++++

The ``trees`` group is mandatory, and describes the tree sequence. A tree
sequence is a sequence of coalescent records, and each record consists of
five fields. The ``left`` and ``right`` fields define the genomic interval
over which the record applies. The interval is half-open, so that the
left coordinate is inclusive and the right coordinate is exclusive. Every
genomic coordinate :math:`x` must lie in the range :math:`0 \leq x < m`,
where :math:`m` is the sequence length defined in the root attribute
``sequence_length``.

The ``node`` and ``children`` fields in a coalescence record define the
event of the given node becoming the parent of the given pair of
children. Every node is a positive integer. The ``time`` field in a
coalescence record then defined the time at which this event occured.

The ``trees`` group contains these coalescence records. The records are
stored in the form of a seperate vector for each field for efficiency reasons.
The following table defines the types and structures of the datasets in
this group (assuming we have N records).

The order of the records is arbitrary, and should not be relied on.

===============     ==============      =====
Path                Type                Dim
===============     ==============      =====
/trees/left         H5T_STD_U32LE       N
/trees/right        H5T_STD_U32LE       N
/trees/node         H5T_STD_U32LE       N
/trees/time         H5T_IEEE_F64LE      N
/trees/children     H5T_STD_U32LE       (N, 2)
===============     ==============      =====

The ``trees`` group also contains some attributes defining provenance
information required to replicated the simulations.

================    ==============      ======      ===========
Path                Type                Dim         Description
================    ==============      ======      ===========
/parameters         H5T_STRING          Scalar      The parameters used to simulate the trees.
/environment        H5T_STRING          Scalar      The simulation environment.
================    ==============      ======      ===========

These attributes are implementation defined strings. No internal format
is required, other than that the original implementation should be
able to reproduce the precise simulation given these values. In the
current version of ``msprime``, the ``parameters`` value is a JSON
object describing all the simulation parameters and the ``environment``
value is a JSON object giving platform and library version information.

+++++++++++++++
Mutations group
+++++++++++++++

The ``mutations`` group is optional, and describes the location of mutations
with respect to tree nodes and their positions along the sequence.
